ğŸ“Œ **Objective**
Make sphbuddy work identically in Preview and at https://sphbuddy.info  
â€¢ One shared Postgres DB (Supabase)  
â€¢ Schema managed by Drizzle CLI migrations  
â€¢ No emergency / bypass code  
â€¢ Normal auth, optional Slack/Asana validation  
â€¢ End-to-end test: log in with `DanielZ / Israel`, create chatbot â†’ 200 OK

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Clean-Up PREVIOUS PATCHES
   â€¢ Delete / revert these files if they exist:
       server/direct-sql-routes.ts
       server/emergency-routes.js
       client/src/lib/queryClient.ts  (only the â€œemergency*â€ helpers)
       db-schema-fix.sql
   â€¢ In server/auth.ts, restore normal auth middleware (remove hard-coded admin user / production bypass).
   â€¢ In server/storage.ts or server/routes.ts, remove the raw-SQL fallbacks we added.
   â€¢ Keep the â€œsecure: process.env.NODE_ENV === 'production'â€ cookie flag BUT
         add   `sameSite: 'lax'`
         and   `proxy: true`   (Express) â€“ donâ€™t set secure=false in prod.

2. CREATE MANAGED POSTGRES (once)
   â€¢ Provision a free Postgres on Supabase.  
   â€¢ Obtain the full connection string (postgres://user:pass@host:port/db?sslmode=require).

3. CONFIGURE ENV VARIABLES
   â€¢ In Replit *Secrets* **and** in the Deploy tab â†’ Environment:
         DATABASE_URL  =  the Supabase connection string
         NODE_ENV       =  production   (for deployed build)
         SLACK_BOT_TOKEN, ASANA_TOKEN   (leave empty for now if you donâ€™t have them)
   â€¢ Remove any hard-coded sqlite / Replit DB refs.

4. DRIZZLE (or Prisma) MIGRATIONS
   â€¢ Update drizzle.config.ts to read `process.env.DATABASE_URL`.
   â€¢ Run locally in Replit shell:
         npx drizzle-kit generate:pg
         npx drizzle-kit push:pg
     This will create the tables on Supabase.
   â€¢ Commit the generated SQL and `_migrations` directory.

5. SERVER CODE
   â€¢ In server/storage.ts set up a single `pgPool = new Pool({ connectionString: process.env.DATABASE_URL, ssl: { rejectUnauthorized: false } })`
   â€¢ All DB helpers should reuse that pool.

6. OPTIONAL INTEGRATIONS
   â€¢ server/lib/slack.ts â†’ if `!process.env.SLACK_BOT_TOKEN`, skip validation and return `true`.
   â€¢ same for Asana.  Log `console.warn` instead of throwing.

7. BUILD & DEPLOY
   â€¢ `npm run build` (or `pnpm â€¦`) â€“ ensure no TS/ESLint errors.
   â€¢ Click **Deploy** in Replit; wait for green check.

8. SMOKE TEST (agent should script this)
   a) Visit /login on Preview â†’ log in â†’ create chatbot â†’ expect 201.  
   b) Visit https://sphbuddy.info/login â†’ log in with SAME creds â†’ create chatbot â†’ expect 201.  
   c) Verify row exists in Supabase with `SELECT * FROM chatbots LIMIT 5;`.

9. AUTOMATED CHECK
   â€¢ Add `scripts/postdeploy.js` that pings `/healthz` and attempts a test chatbot insert; exit 1 on failure so deploy rolls back.

10. DOCUMENT
   â€¢ Update README with:
       â€“ how to add new env vars
       â€“ how to run `drizzle-kit generate/push`
       â€“ how to connect to Supabase for psql.

ğŸ“£  Deliverable
   â€œDeployment succeeded with unified DB. Login + chatbot creation work both locally and at sphbuddy.info.â€

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
